<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highland Fresh - Cashier Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="cashier-dashboard.html">
                <img src="../images/highland_fresh_logo.jpg" alt="Highland Fresh Logo" class="navbar-logo">
                Highland Fresh - Cashier
            </a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3" id="userWelcome">
                    <i class="bi bi-person-circle me-1"></i>Welcome, Cashier
                </span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <div class="row">
            <div class="col-12">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="dashboard-title mb-2">
                            <i class="bi bi-cash-coin me-2"></i>Highland Fresh Cashier Hub
                        </h1>
                        <p class="dashboard-subtitle mb-0">
                            <i class="bi bi-lightning-fill me-1"></i>
                            Fast dairy product sales processing and transaction management
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="alertContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="feature-card" onclick="window.location.href='pos.html'" style="cursor: pointer;">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="bi bi-shop"></i>
                        </div>
                        <h4 class="card-title">Point of Sale</h4>
                        <p class="card-text mb-4">
                            Start processing Highland Fresh dairy product sales - milk, cheese, yogurt, and more.
                        </p>
                        <button class="btn btn-feature">
                            <i class="bi bi-play-fill me-2"></i>Start POS
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="feature-card" onclick="window.location.href='transaction-history.html'" style="cursor: pointer;">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <h4 class="card-title">Transaction History</h4>
                        <p class="card-text mb-4">
                            View and manage your Highland Fresh sales history and generate reports.
                        </p>
                        <button class="btn btn-feature">
                            <i class="bi bi-list-ul me-2"></i>View History
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="main-card">
                    <div class="card-body">
                        <h5 class="mb-4 d-flex align-items-center">
                            <i class="bi bi-graph-up-arrow me-2" style="color: var(--hf-primary);"></i>
                            Today's Performance
                        </h5>
                        
                        <div class="row text-center">
                            <div class="col-lg-3 col-6 mb-3">
                                <div class="p-3">
                                    <div class="feature-icon mb-3">
                                        <i class="bi bi-currency-exchange"></i>
                                    </div>
                                    <div class="h3 mb-1" id="todaySales" style="color: var(--hf-primary); font-weight: 700;">₱0.00</div>
                                    <div class="text-muted small">Today's Sales</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6 mb-3">
                                <div class="p-3">
                                    <div class="feature-icon mb-3">
                                        <i class="bi bi-receipt"></i>
                                    </div>
                                    <div class="h3 mb-1" id="todayTransactions" style="color: var(--info-color); font-weight: 700;">0</div>
                                    <div class="text-muted small">Transactions</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6 mb-3">
                                <div class="p-3">
                                    <div class="feature-icon mb-3">
                                        <i class="bi bi-calculator"></i>
                                    </div>
                                    <div class="h3 mb-1" id="avgTransaction" style="color: var(--warning-color); font-weight: 700;">₱0.00</div>
                                    <div class="text-muted small">Avg. Transaction</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6 mb-3">
                                <div class="p-3">
                                    <div class="feature-icon mb-3">
                                        <i class="bi bi-basket-fill"></i>
                                    </div>
                                    <div class="h3 mb-1" id="itemsSold" style="color: var(--hf-primary); font-weight: 700;">0</div>
                                    <div class="text-muted small">Items Sold</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api-handler.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
        // Highland Fresh Dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            checkAuth();
            // Load real dashboard data
            loadTodayStats();
        });

        async function checkAuth() {
            try {
                let user = getLoggedInUser();
                let sessionStorageValid = user && user.role;

                if (!sessionStorageValid) {
                    // Check server-side session
                    const response = await fetch('../api/SessionStatusAPI.php', { credentials: 'include' });
                    const sessionStatus = await response.json();
                    
                    if (sessionStatus.success && sessionStatus.authenticated) {
                        user = sessionStatus.user;
                        sessionStorage.setItem('user', JSON.stringify(user));
                    } else {
                        console.log('Session not valid, redirecting to login');
                        alert('Session expired. Please login again.');
                        window.location.href = 'login.html';
                        return;
                    }
                }

                if (!user || (user.role !== 'Cashier' && user.role !== 'Admin')) {
                    console.log('User role not authorized:', user ? user.role : 'no user');
                    alert('Access denied. Cashier or Admin access required.');
                    window.location.href = 'login.html';
                    return;
                }

                document.getElementById('userWelcome').innerHTML = 
                    `<i class="bi bi-person-circle me-1"></i>Welcome, ${user.username}`;
                console.log('User authenticated:', user.username, user.role);
            } catch (error) {
                console.error('Auth check failed:', error);
                alert('Authentication error. Please login again.');
                window.location.href = 'login.html';
            }
        }

        async function loadTodayStats() {
            try {
                // Get today's sales data
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`../api/SalesAPI.php?operation=getTodayStats&date=${today}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const stats = result.data;
                        
                        // Update with real data
                        document.getElementById('todaySales').textContent = `₱${parseFloat(stats.total_sales || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
                        document.getElementById('todayTransactions').textContent = (stats.transaction_count || 0).toString();
                        document.getElementById('itemsSold').textContent = (stats.items_sold || 0).toString();
                        
                        // Calculate average transaction
                        const avgTransaction = stats.transaction_count > 0 ? (stats.total_sales / stats.transaction_count) : 0;
                        document.getElementById('avgTransaction').textContent = `₱${avgTransaction.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
                    }
                } else {
                    console.log('Could not load today stats, using defaults');
                    // Set defaults
                    document.getElementById('todaySales').textContent = '₱0.00';
                    document.getElementById('todayTransactions').textContent = '0';
                    document.getElementById('avgTransaction').textContent = '₱0.00';
                    document.getElementById('itemsSold').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading today stats:', error);
                // Set defaults on error
                document.getElementById('todaySales').textContent = '₱0.00';
                document.getElementById('todayTransactions').textContent = '0';
                document.getElementById('avgTransaction').textContent = '₱0.00';
                document.getElementById('itemsSold').textContent = '0';
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await fetch('../api/LogoutAPI.php', { method: 'POST' });
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = 'login.html';
                }
            }
        }
    </script>
</body>
</html>